---
title: "EV Power - Lab 4 Project Report"
format: typst
---

# Derek Zhang

## **Part 0: libraries**

```{r}
library(tidyverse)
library(readr)

renew_2021 <- read_csv("data/renew-use-2021.csv")
renew_2022 <- read_csv("data/renew-use-2022.csv")
renew_2023 <- read_csv("data/renew-use-2023.csv")

total_2021 <- read_csv("data/total-use-2021.csv")
total_2022 <- read_csv("data/total-use-2022.csv")
total_2023 <- read_csv("data/total-use-2023.csv")

ev_2023    <- read_csv("data/ev-registrations-by-state-2023.csv")

price_2123 <- read_csv("data/av-energy-price-2021-2023.csv")
```

## **Part 1:** **Defining Research Question**

Chosen Question: How has each state’s share of renewable energy changed from 2021 to 2023? or Which U.S. regions rely most on renewable energy in 2023?

## **Part 2: Data Preparation and Cleaning**

```{r}

if ("State" %in% names(renew_2021)) renew_2021 <- renew_2021 |> rename(state = State)
if ("Energy_Source" %in% names(renew_2021)) renew_2021 <- renew_2021 |> rename(energy_source = Energy_Source)
if ("Renewable_Use_2021" %in% names(renew_2021)) renew_2021 <- renew_2021 |> rename(renewable_use_2021 = Renewable_Use_2021)

if ("State" %in% names(renew_2022)) renew_2022 <- renew_2022 |> rename(state = State)
if ("Energy_Source" %in% names(renew_2022)) renew_2022 <- renew_2022 |> rename(energy_source = Energy_Source)
if ("Renewable_Use_2022" %in% names(renew_2022)) renew_2022 <- renew_2022 |> rename(renewable_use_2022 = Renewable_Use_2022)

if ("State" %in% names(renew_2023)) renew_2023 <- renew_2023 |> rename(state = State)
if ("Energy_Source" %in% names(renew_2023)) renew_2023 <- renew_2023 |> rename(energy_source = Energy_Source)
if ("Renewable_Use_2023" %in% names(renew_2023)) renew_2023 <- renew_2023 |> rename(renewable_use_2023 = Renewable_Use_2023)

if ("Energy_Source" %in% names(total_2021)) total_2021 <- total_2021 |> rename(energy_source = Energy_Source)
if ("Energy_Source" %in% names(total_2022)) total_2022 <- total_2022 |> rename(energy_source = Energy_Source)
if ("Energy_Source" %in% names(total_2023)) total_2023 <- total_2023 |> rename(energy_source = Energy_Source)

if ("State" %in% names(ev_2023)) ev_2023 <- ev_2023 |> rename(state = State)

if ("State" %in% names(price_2123)) price_2123 <- price_2123 |> rename(state = State)

```

## **Part 3: Joining / Pivoting Datasets for Analysis**

```{r}
#Pivot each year to long and combining

total_2021_long <- total_2021 |>
  pivot_longer(
    cols = -energy_source,              
    names_to = "state_abbr",            
    values_to = "value"
  ) |>
  mutate(year = 2021)

total_2022_long <- total_2022 |>
  pivot_longer(
    cols = -energy_source,
    names_to = "state_abbr",
    values_to = "value"
  ) |>
  mutate(year = 2022)

total_2023_long <- total_2023 |>
  pivot_longer(
    cols = -energy_source,
    names_to = "state_abbr",
    values_to = "value"
  ) |>
  mutate(year = 2023)

# one combined table for 2021–2023
total_all_long <- bind_rows(total_2021_long, total_2022_long, total_2023_long)

# (1) total energy across all sources
total_by_state_year <- total_all_long |>
  group_by(state_abbr, year) |>
  summarise(total_energy = sum(value, na.rm = TRUE), .groups = "drop")

# (2) renewable-only row(s) per state/year
renew_by_state_year <- total_all_long |>
  filter(str_detect(energy_source, "renewable")) |>
  group_by(state_abbr, year) |>
  summarise(renewable_energy = sum(value, na.rm = TRUE), .groups = "drop")

# (3) join and compute percentage renewable
energy_share <- total_by_state_year |>
  left_join(renew_by_state_year, by = c("state_abbr", "year")) |>
  mutate(renew_pct = 100 * renewable_energy / total_energy)

energy_share |> arrange(year, desc(renew_pct)) |> head(10)

```

## **Part 4: Mapping Visualization**

```{r}
# Load the map data 
library(maps)

# Step 1: Get map of U.S. states
us_map <- map_data("state")

# The map uses lowercase full state names (e.g., "california"), not "CA".

state_lookup <- tibble(
  state_abbr = state.abb,
  region = tolower(state.name)
)

# Step 3: Join energy_share data for 2021 (or 2023)
energy_map <- energy_share |>
  filter(year == 2021) |>        
  left_join(state_lookup, by = "state_abbr") |>
  left_join(us_map, by = "region")

# Step 4: Draw the map
ggplot(energy_map, aes(long, lat, group = group, fill = renew_pct)) +
  geom_polygon(color = "white") +
  coord_fixed(1.3) +
  scale_fill_viridis_c(option = "plasma", name = "% Renewable") +
  labs(
    title = "Share of Renewable Energy by State (2021)",
    subtitle = "Percentage of total energy from renewable sources",
    caption = "Source: U.S. Energy Data 2021–2023"
  ) +
  theme_minimal() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank()
  )

```